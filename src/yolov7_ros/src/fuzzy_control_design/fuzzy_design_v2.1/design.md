# 模糊控制器設計文件 v2.1

> **版本**：v2.1 (純模糊控制器 + 低通濾波)  
> **日期**：2026-01-08  
> **作者**：自動產生  
> **設計目標**：在保持避障靈敏度的同時，實現平滑穩定的運動控制

---

## 1. 系統架構

### 1.1 控制流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           視覺感知模組                                    │
│  YOLO11-Seg 道路分割 → BEV 轉換 → 參考點提取 → 誤差計算                    │
└────────────────────────────┬────────────────────────────────────────────┘
                             │ 輸入: (e_d, e_d_dot, e_l, e_l_dot)
                             ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           模糊控制器                                      │
│  ┌─────────┐   ┌──────────┐   ┌───────────┐   ┌─────────┐   ┌────────┐ │
│  │ 模糊化   │ → │ 規則評估  │ → │ 加權平均   │ → │ 範圍限制 │ → │ 低通濾波│ │
│  └─────────┘   └──────────┘   └───────────┘   └─────────┘   └────────┘ │
└────────────────────────────┬────────────────────────────────────────────┘
                             │ 輸出: (v, ω)
                             ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           運動執行模組                                    │
│  /fuzzy_cmd_vel → /cmd_vel → 差速驅動控制                                 │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 設計原則

| 原則 | 說明 |
|:---:|:---|
| **純模糊邏輯** | 控制行為主要由 625 條模糊規則和隸屬函數決定 |
| **最小後處理** | 僅使用範圍限制 + 低通濾波，無其他增益或修正 |
| **安全優先** | 透過規則設計確保：偏移時降速、低速時減少角速度 |
| **平滑運動** | 透過低通濾波消除抖動，實現流暢的軌跡追蹤 |

---

## 2. 輸入變數定義

### 2.1 前方距離誤差 e_d

前方距離誤差定義為：道路可視終點到停止參考點的距離（單位：m）。

| 語言變數 | 三角參數 (a, b, c) | 物理意義 |
|:-------:|:-----------------:|:--------|
| VN (Very Near) | (0.0, 0.0, 0.52) | 危險區域，需緊急停止 |
| N (Near) | (0.0, 0.52, 1.04) | 接近停止距離，需減速 |
| M (Medium) | (0.52, 1.04, 1.56) | 正常行駛區域 |
| F (Far) | (1.04, 1.56, 2.08) | 安全距離，可中速行駛 |
| VF (Very Far) | (1.56, 2.08, 2.08) | 視野良好，可高速行駛 |

**參數說明**：
- **停止距離基準**：1.04 m（相機前方物理距離）
- **範圍**：[0, 2.08] m
- **VN/VF 為梯形**：邊界處隸屬度維持 1.0

### 2.2 前方距離變化率 e_d_dot

定義為 e_d 的時間導數（單位：m/s）。

| 語言變數 | 三角參數 (a, b, c) | 物理意義 |
|:-------:|:-----------------:|:--------|
| NB (Negative Big) | (-2.08, -2.08, -1.04) | 快速接近障礙物 |
| NS (Negative Small) | (-2.08, -1.04, 0.0) | 慢速接近障礙物 |
| ZO (Zero) | (-1.04, 0.0, 1.04) | 距離穩定 |
| PS (Positive Small) | (0.0, 1.04, 2.08) | 慢速遠離障礙物 |
| PB (Positive Big) | (1.04, 2.08, 2.08) | 快速遠離障礙物 |

### 2.3 橫向誤差 e_l（非對稱死區設計）

定義為道路中心線到機器人中心的橫向距離（單位：m）。正值表示右偏，負值表示左偏。

| 語言變數 | 三角參數 (a, b, c) | 設計特點 |
|:-------:|:-----------------:|:--------|
| NB (Negative Big) | (-1.0, -0.5, -0.15) | 左偏大，需強力右轉 |
| NS (Negative Small) | (-0.5, -0.15, **-0.05**) | 終點 -0.05，創造死區 |
| ZO (Zero) | (**-0.08**, 0.0, **0.08**) | 擴大死區至 ±0.08m |
| PS (Positive Small) | (**0.05**, 0.15, 0.5) | 起點 0.05，創造死區 |
| PB (Positive Big) | (0.15, 0.5, 1.0) | 右偏大，需強力左轉 |

**設計要點**：
- **純死區**：[-0.05, 0.05] 區間內只有 ZO 激發，無轉向輸出
- **目的**：避免微小擾動觸發不必要的轉向修正

### 2.4 橫向變化率 e_l_dot

定義為 e_l 的時間導數（單位：m/s）。

| 語言變數 | 三角參數 (a, b, c) | 物理意義 |
|:-------:|:-----------------:|:--------|
| NB (Negative Big) | (-1.5, -1.0, -0.5) | 快速左偏 |
| NS (Negative Small) | (-1.0, -0.5, 0.0) | 慢速左偏 |
| ZO (Zero) | (-0.5, 0.0, 0.5) | 橫向穩定 |
| PS (Positive Small) | (0.0, 0.5, 1.0) | 慢速右偏 |
| PB (Positive Big) | (0.5, 1.0, 1.0) | 快速右偏 |

---

## 3. 輸出變數定義

### 3.1 線速度 v（Singleton）

| 語言變數 | 數值 (m/s) | 設計考量 |
|:-------:|:---------:|:--------|
| S (Stop) | 0.00 | 緊急停止 |
| VS (Very Slow) | 0.18 | 近距離緩行（從 0.15 提高） |
| SL (Slow) | 0.32 | 偏移時減速（從 0.30 提高） |
| M (Medium) | 0.45 | 正常行駛 |
| F (Fast) | 0.55 | 遠距離直行（從 0.60 降低） |

**設計要點**：壓縮低速區間，減少等級間跳動感

### 3.2 角速度 ω（Singleton）

| 語言變數 | 數值 (rad/s) | 設計考量 |
|:-------:|:-----------:|:--------|
| NB (Negative Big) | -1.4 | 大幅右轉（從 -2.0 降低） |
| NS (Negative Small) | -0.5 | 小幅右轉（從 -1.0 降低） |
| ZO (Zero) | 0.0 | 直行 |
| PS (Positive Small) | 0.5 | 小幅左轉（從 1.0 降低） |
| PB (Positive Big) | 1.4 | 大幅左轉（從 2.0 降低） |

**設計要點**：大幅降低輸出值，減少轉彎時的擺動

---

## 4. 模糊規則設計

### 4.1 規則總數

- **完整覆蓋**：5 × 5 × 5 × 5 = **625 條**
- **規則檔案**：`fuzzy_rules_relaxed.csv`

### 4.2 規則產生邏輯

採用**分階段合成法**：

1. **階段 1**：建立基準規則（表 1A、表 1B）
2. **階段 2**：應用交互作用修正（表 2A、表 2B）

#### 表 1A：線速度基準規則

| e_d ＼ e_d_dot | NB | NS | ZO | PS | PB |
|:---:|:---:|:---:|:---:|:---:|:---:|
| VN | S | S | S | VS | VS |
| N | S | VS | VS | SL | SL |
| M | SL | SL | SL | M | F |
| F | SL | M | M | F | F |
| VF | M | M | F | F | F |

#### 表 1B：角速度基準規則

| e_l ＼ e_l_dot | NB | NS | ZO | PS | PB |
|:---:|:---:|:---:|:---:|:---:|:---:|
| NB | PB | PB | PB | PS | PS |
| NS | PB | PB | PS | PS | PS |
| ZO | PS | PS | ZO | NS | NS |
| PS | NS | NS | NS | NB | NB |
| PB | NS | NS | NB | NB | NB |

#### 表 2A：線速度修正（受 e_l 影響）

| e_l | 修正 | 原因 |
|:---:|:---:|:---|
| NB | -2 | 大偏移必須大幅減速 |
| NS | -1 | 小偏移適度減速 |
| ZO | 0 | 置中不修正 |
| PS | -1 | 小偏移適度減速 |
| PB | -2 | 大偏移必須大幅減速 |

#### 表 2B：角速度修正（受 e_d 影響）

| e_d | 修正 | 原因 |
|:---:|:---:|:---|
| VN | -1 | 低速時減少角速度，避免擺動 |
| N | 0 | 不修正 |
| M | 0 | 不修正 |
| F | 0 | 不修正 |
| VF | 0 | 不修正 |

### 4.3 規則分佈統計

| 線速度 | 數量 | 比例 | | 角速度 | 數量 | 比例 |
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
| S | 240 | 38.4% | | NB | 100 | 16.0% |
| VS | 130 | 20.8% | | NS | 165 | 26.4% |
| SL | 140 | 22.4% | | ZO | 95 | 15.2% |
| M | 85 | 13.6% | | PS | 165 | 26.4% |
| F | 30 | 4.8% | | PB | 100 | 16.0% |

---

## 5. 模糊推論方法

### 5.1 模糊化

使用三角形/梯形隸屬函數計算每個輸入在各語言變數的隸屬度。

```python
def triangular_mf(x, a, b, c):
    if x <= a:
        return 1.0 if a == b else 0.0
    elif x <= b:
        return (x - a) / (b - a)
    elif x <= c:
        return (c - x) / (c - b)
    else:
        return 1.0 if b == c else 0.0
```

### 5.2 規則評估

對每條規則計算激發強度（AND 運算 = 最小值）：

```python
firing_strength = min(μ_e_d, μ_e_d_dot, μ_e_l, μ_e_l_dot)
```

### 5.3 解模糊化 (Defuzzification)

本系統使用 **加權平均法 (Weighted Average Method)** 將模糊推論的結果轉換為具體的控制數值。此方法特別適用於 Singleton（單值型）輸出歸屬函數。

**公式：**

$$
y = \frac{\sum_{i=1}^{N} (w_i \cdot c_i)}{\sum_{i=1}^{N} w_i}
$$

**Python 實作：**

```python
v = Σ(firing_strength × v_singleton) / Σ(firing_strength)
ω = Σ(firing_strength × ω_singleton) / Σ(firing_strength)
```

**參數說明：**
- $N$：被觸發的規則總數。
- $w_i$ (firing_strength)：第 $i$ 條規則的激發強度（由該規則所有輸入條件的隸屬度取最小值 `min` 得到）。
- $c_i$ (singleton)：第 $i$ 條規則對應的輸出單值（例如 `SL=0.32`）。
- $y$：最終輸出的解模糊數值（即 `v` 或 `ω`）。

**選用理由：**
1.  **計算效率高**：相比重心法 (Center of Gravity) 需要對面積積分，加權平均法僅需簡單的乘加運算，非常適合實時控制系統 (Real-time System)。
2.  **直觀性**：輸出值直接由各規則的建議值依權重混合而成，易於預測和調試。
3.  **適用性**：配合 Singleton 輸出隸屬函數使用是標準做法。

---

## 6. 後處理設計

### 6.1 輸出範圍限制

```python
v = np.clip(v, 0.0, 0.55)      # 線速度上限 0.55 m/s
omega = np.clip(omega, -1.4, 1.4)  # 角速度上限 ±1.4 rad/s
```

### 6.2 低通濾波器 (Low-Pass Filter)

為了消除感測器雜訊與規則切換時的數值跳動，採用 **指數移動平均 (Exponential Moving Average, EMA)** 進行平滑處理。這相當於一個數位一階低通濾波器。

**公式：**

$$
y_t = \alpha \cdot x_t + (1 - \alpha) \cdot y_{t-1}
$$

**Python 實作：**

```python
v_filtered = alpha_v * v_raw + (1 - alpha_v) * prev_v
omega_filtered = alpha_omega * omega_raw + (1 - alpha_omega) * prev_omega
```

**參數詳細說明：**

*   **$y_t$ (`v_filtered` / `omega_filtered`)**：當前時刻的濾波後輸出值。這是實際傳送給馬達控制器的命令。
*   **$x_t$ (`v_raw` / `omega_raw`)**：當前時刻由模糊控制器計算出的原始輸出值（含有高頻雜訊）。
*   **$y_{t-1}$ (`prev_v` / `prev_omega`)**：上一時刻的濾波後輸出值（歷史狀態）。
*   **$\alpha$ (`alpha_v` / `alpha_omega`)**：**平滑係數 (Smoothing Factor)**，範圍 $0 < \alpha \le 1$。
    *   **$\alpha$ 越大 (接近 1)**：參考當前值權重越大，反應越快，但平滑效果越差（雜訊越多）。
    *   **$\alpha$ 越小 (接近 0)**：參考歷史值權重越大，反應越慢，但平滑效果越好（數值越穩定）。

**參數設定與理由：**

| 參數 | 數值 | 濾波強度 | 設計理由 |
|:---:|:---:|:---:|:---|
| **$\alpha_v$** | **0.2** | **強** | **消除移動猶豫**。線速度 `v` 容易因距離 `e_d` 的跳動而劇烈變化，使用強濾波（0.2）可以讓加速和減速過程非常平滑，避免機器人「頓挫」。反應時間約 0.5 秒。 |
| **$\alpha_\omega$** | **0.3** | **中** | **減少轉向擺動**。角速度 `ω` 需要保持一定的靈敏度以避開障礙，因此濾波不能太強。設定 0.3 可在保留轉向反應（約 0.3 秒）的同時，有效濾除高頻的左右擺動訊號。 |

---

## 7. ROS 整合

### 7.1 節點架構

```
mod_fuzzy_control4.py
├── FuzzyController4Input      # 模糊推論核心
│   ├── __init__()             # 載入規則、初始化濾波器
│   ├── compute()              # 執行推論 + 後處理
│   └── compute_with_logging() # 帶日誌的推論
└── FuzzyControllerNode        # ROS 節點
    ├── road_info_callback()   # 處理視覺輸入
    ├── voice_command_callback() # 處理語音命令
    └── run()                  # 主迴圈
```

### 7.2 Topic 定義

| Topic | 類型 | 方向 | 說明 |
|:------|:-----|:----:|:-----|
| `/road_info` | Float32MultiArray | 輸入 | [detected, e_d, e_d_dot, e_l, e_l_dot, y, x] |
| `/fuzzy_cmd_vel` | Twist | 輸出 | 控制命令 (v, ω) |
| `/avoidance_enabled` | String | 輸入 | 鍵盤控制開關 |
| `/voice_command_code` | String | 輸入 | 語音命令代碼 |

---

## 8. 調參指南

### 8.1 常見問題與對策

| 問題 | 可能原因 | 調整建議 |
|:---|:---|:---|
| 轉彎擺動 | ω 輸出過大 | 降低 OMEGA 的 NS/PS/NB/PB 值 |
| 移動猶豫 | v 變化劇烈 | 降低 α_v（增強濾波）|
| 轉向遲鈍 | ω 濾波過強 | 提高 α_ω |
| 直線偏移 | 死區過大 | 縮小 E_L.ZO 範圍 |
| 撞上障礙物 | 規則設計 | 檢查表 2A/2B 修正邏輯 |

### 8.2 參數敏感度

| 參數 | 影響範圍 | 建議步長 |
|:---:|:---|:---:|
| OMEGA 輸出值 | 轉向幅度 | ±0.1 rad/s |
| V 輸出值 | 速度等級 | ±0.02 m/s |
| α_v | 線速度平滑度 | ±0.05 |
| α_ω | 角速度平滑度 | ±0.05 |
| E_L.ZO | 死區大小 | ±0.01 m |

---

## 9. 檔案結構

```
yolov7_ros/
├── scripts/
│   └── mod_fuzzy_control4.py        # 模糊控制器主程式
└── src/fuzzy_control_design/
    ├── design.md                    # 本文件
    ├── fuzzy_rules_design_template.md  # 規則設計模板
    ├── generate_fuzzy_rules.py      # 規則產生腳本
    ├── fuzzy_rules_relaxed.csv      # 625 條規則表
    ├── membership_function_print.py # 隸屬函數繪圖
    └── fuzzy_inference_surface.py   # 推論曲面繪圖
```

---

## 10. 版本歷史

| 版本 | 日期 | 變更內容 |
|:---:|:---:|:---|
| v1.0 | 2025-12-26 | 初始設計，包含後處理增益 |
| v2.0 | 2026-01-08 | 純模糊控制器，移除速度耦合增益 |
| v2.1 | 2026-01-08 | 恢復 LPF，優化 E_L 死區，降低 OMEGA 輸出 |

---

## 附錄 A：隸屬函數圖

執行 `membership_function_print.py` 可產生所有隸屬函數的視覺化圖表。

## 附錄 B：推論曲面圖

執行 `fuzzy_inference_surface.py` 可產生以下控制曲面：
- v = f(e_d, e_l)
- v = f(e_d, e_d_dot)
- ω = f(e_l, e_l_dot)
- ω = f(e_l, e_d)
